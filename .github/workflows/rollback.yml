name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - production
          - staging
      commit_sha:
        description: 'Commit SHA to rollback to (leave empty for previous deployment)'
        required: false
        type: string

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine rollback target
        id: target
        run: |
          if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
            TARGET_SHA="${{ github.event.inputs.commit_sha }}"
          else
            # Get the previous commit
            TARGET_SHA=$(git log --format="%H" -n 2 | tail -1)
          fi

          echo "target_sha=$TARGET_SHA" >> $GITHUB_OUTPUT
          echo "Rolling back to commit: $TARGET_SHA"

          # Get commit message
          COMMIT_MSG=$(git log --format="%s" -n 1 $TARGET_SHA)
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Checkout target commit
        run: |
          git checkout ${{ steps.target.outputs.target_sha }}

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build:frontend
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: ${{ secrets.PRODUCTION_API_URL || 'https://api.connectivebyte.com' }}

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './apps/frontend/out'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Rollback to ${{ steps.target.outputs.target_sha }} - ${{ steps.target.outputs.commit_message }}'
          production-deploy: ${{ github.event.inputs.environment == 'production' }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 10

      - name: Verify rollback
        run: |
          sleep 10

          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            URL="${{ secrets.PRODUCTION_FRONTEND_URL || 'https://connectivebyte.netlify.app' }}"
          else
            URL="${{ secrets.STAGING_FRONTEND_URL || 'https://staging--connectivebyte.netlify.app' }}"
          fi

          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")

          if [ "$STATUS_CODE" -eq 200 ]; then
            echo "‚úÖ Rollback successful! Site is accessible at $URL"
          else
            echo "‚ùå Rollback verification failed (HTTP $STATUS_CODE)"
            exit 1
          fi

      - name: Create rollback issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Rollback performed on ${{ github.event.inputs.environment }}`,
              body: `## Rollback Details

              - **Environment:** ${{ github.event.inputs.environment }}
              - **Rolled back to:** ${{ steps.target.outputs.target_sha }}
              - **Commit message:** ${{ steps.target.outputs.commit_message }}
              - **Performed by:** @${{ github.actor }}
              - **Timestamp:** ${new Date().toISOString()}

              ## Action Required

              Please investigate the issue that caused this rollback and create a fix.

              ## Verification

              - [ ] Site is accessible
              - [ ] Core functionality works
              - [ ] No errors in logs
              - [ ] Issue has been identified
              - [ ] Fix has been implemented
              - [ ] Fix has been tested
              - [ ] Ready for redeployment
              `,
              labels: ['rollback', 'urgent', ${{ github.event.inputs.environment }}]
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Notify team
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "üîÑ Rollback completed successfully"
            echo "Environment: ${{ github.event.inputs.environment }}"
            echo "Target commit: ${{ steps.target.outputs.target_sha }}"
          else
            echo "‚ùå Rollback failed"
            echo "Please check the logs and perform manual rollback if necessary"
          fi
